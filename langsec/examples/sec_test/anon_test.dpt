include "../anonymize/anonymize.dpt"

const LOW int SERVER_PORT = 0;
const HIGH int OUT_PORT = 1;

global Anonymizer.t anonymizer = Anonymizer.create();

packet event eth_ip(HIGH int<48> dmac, HIGH int<48> smac, int<16> etype, HIGH int src, HIGH int dst, int<16> len);
packet event low_eth_ip(LOW int<48> dmac, LOW int<48> smac, int<16> etype, LOW int src, LOW int dst, int<16> len) {skip;}

handle eth_ip(HIGH int<48> dmac, HIGH int<48> smac, int<16> etype, HIGH int src, HIGH int dst, int<16> len) {
    generate_port(OUT_PORT, eth_ip(dmac, smac, etype, src, dst, len));
    Anonymizer.eth_ip_t pckt = Anonymizer.anonymize_packet(anonymizer, dmac, smac, etype, src, dst, len);
    Anonymizer.eth_t eth = pckt#eth;
    Anonymizer.ip_t ip = pckt#ip;
    generate_port(SERVER_PORT, low_eth_ip(eth#dmac, eth#smac, eth#etype, ip#src, ip#dst, ip#len));
}