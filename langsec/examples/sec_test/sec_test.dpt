type ip_t = {
    HIGH int src;
    HIGH int dst;
}

global Array.t<32> arr = Array.create(10);

packet event ip(HIGH int dst);

fun HIGH int test(int i) {
    return 5;
}

// generalize type to: HIGH int -> 'a int
fun int test2(HIGH int i) { // check that arguments are equal to HIGH int
    return 4;
}

fun int test3(int i) {
    return 3;
}

handle ip(int dst) {                                    // HIGH propagates to dst in handler
    int x = dst + 1;
    x = 3;
    LOW int y = 2;
    // int z = down(x);
    // int x = dst+1;                                      // HIGH propagates to x
    
    // int i = test(4);                                    // HIGH propagates to i
    // int j = test2(4);                                   // HIGH propagates to j
    // int k = test3(x);                                   // HIGH propagates to k
    
    ip_t ip_addr = { src = 1; dst = 2 };
    // ip_addr = { ip_addr with src = x };
    int w = ip_addr#src;                                // HIGH propagates to w
    int v = ip_addr#dst;                                // but v is not HIGH (as expected)
    // // Propagation also works for size casting, hashing, polymorphism, and getting values from HIGH array

    // // But doesn't work for...
    // HIGH ip_t ip_addr2 = { src = 3; dst = 4; };         // src + dst both marked LOW
    // int a = ip_addr2#src;                               // a + b both marked LOW        
    // int b = ip_addr2#dst;
    // ip_t ip_addr3 = { src = a; dst = b; };
    
    // HIGH int[4] vec = [0; 1; 2; 3];                     // all values in vector marked LOW still
    // int w = vec[0];                                     // w is marked LOW

    // generate_port(1, ip(x));
    // HIGH bool y = true;
    // if (y) {
    //     generate_port(1, ip(1));                        // doesn't throw error
    // }
    // else {
    //     generate_port(1, ip(2));                        // doesn't throw error
    // }
    // Tables also don't work
}